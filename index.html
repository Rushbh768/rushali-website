<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghumti - Coffee Order</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="brewup-logo.png" alt="BrewUp Logo" class="logo">
            <h1>Ghumti Coffee Order</h1>
        </div>

        <form id="coffeeOrderForm">
            <div class="coffee-items">
                <div class="item">
                    <img src="americano.jpg" alt="Americano">
                    <label>
                        <input type="checkbox" name="coffee" value="Americano - Rs. 150" data-price="150"> Americano
                    </label>
                    <span>Rs. 150</span>
                </div>
                <div class="item">
                    <img src="hot-coffee.jpg" alt="Hot Coffee">
                    <label>
                        <input type="checkbox" name="coffee" value="Hot Coffee - Rs. 180" data-price="180"> Hot Coffee
                    </label>
                    <span>Rs. 180</span>
                </div>
                <div class="item">
                    <img src="iced-latte.jpg" alt="Iced Latte">
                    <label>
                        <input type="checkbox" name="coffee" value="Iced Latte - Rs. 200" data-price="200"> Iced Latte
                    </label>
                    <span>Rs. 200</span>
                </div>
                <div class="item">
                    <img src="cold-coffee.jpg" alt="Cold Coffee">
                    <label>
                        <input type="checkbox" name="coffee" value="Cold Coffee - Rs. 170" data-price="170"> Cold Coffee
                    </label>
                    <span>Rs. 170</span>
                </div>
                 </div>

            <div class="contact-info">
                <label for="phone">Phone Number:</label>
                <input type="tel" id="phone" name="phone" required>

                <label for="address">Address:</label>
                <textarea id="address" name="address" rows="3" required></textarea>
            </div>

            <div class="total-section">
                <span>Total: Rs. <span id="totalAmount">0</span></span>
            </div>

            <button type="submit" id="placeOrderBtn">Place Order</button>
        </form>
    </div>

    <footer>
        <p>&copy; 2025 Ghumti Coffee. All rights reserved.</p>
    </footer>

    <script>
        const coffeeOrderForm = document.getElementById('coffeeOrderForm');
        const totalAmountSpan = document.getElementById('totalAmount');
        const coffeeCheckboxes = document.querySelectorAll('input[name="coffee"]');
        const placeOrderBtn = document.getElementById('placeOrderBtn');

        let total = 0;

        coffeeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                total = 0;
                coffeeCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        total += parseInt(cb.dataset.price);
                    }
                });
                totalAmountSpan.textContent = total;
            });
        });

        // Function to generate a UUID (for unique request_id)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        coffeeOrderForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            // Disable the button immediately
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'Processing...';

            const selectedCoffees = Array.from(coffeeCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            const phoneNumber = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const totalAmount = total; // Use the calculated total

            if (selectedCoffees.length === 0) {
                alert('Please select at least one coffee item.');
                placeOrderBtn.disabled = false; // Re-enable button
                placeOrderBtn.textContent = 'Place Order';
                return;
            }

            // Generate a unique ID for this request
            const requestId = generateUUID();

            const orderData = {
                coffee_items: selectedCoffees,
                phone_number: phoneNumber,
                address: address,
                total_amount: totalAmount,
                request_id: requestId // Include the unique ID
            };

            try {
                const response = await fetch('/netlify/functions/place-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    // Redirect on success
                    window.location.href = '/thank-you.html';
                } else {
                    const errorText = await response.text();
                    console.error('Error submitting order:', errorText);
                    alert('There was an error processing your order. Please try again.');
                    placeOrderBtn.disabled = false; // Re-enable button on error
                    placeOrderBtn.textContent = 'Place Order';
                }
            } catch (error) {
                console.error('Network error:', error);
                alert('A network error occurred. Please check your connection and try again.');
                placeOrderBtn.disabled = false; // Re-enable button on error
                placeOrderBtn.textContent = 'Place Order';
            }
        });
    </script>
</body>
</html>
